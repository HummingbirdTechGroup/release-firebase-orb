description: >
  A job to deploy to Firebase hosting with `firebase deploy <your firebase-instruction>`. 
  Persisted files will be attached to root.

parameters:
  firebase-instruction:
    type: string
    description: Used to augment the `firebase deploy` command. i.e `firebase
      deploy [your custom instruction]`.
      Add the destination and project here. This expects a variable called GOOGLE_APPLICATION_CREDENTIALS to be in scope.
      The var should contain the path to a file holding the service account JSON file.
      You can alternatively include a FIRBASE_TOKEN variable.
  workflow-name:
    type: string
    default: Deploy to Firebase
  notify-channel-fail:
    type: string
    default: $SLACK_DEFAULT_CHANNEL
  notify-channel-pass:
    type: string
    default: $SLACK_DEFAULT_CHANNEL

  version:
    default: "15.1"
    description: >
      A full version tag must be specified. Example: "13.11.0" For a full list
      of releases, see the following: https://nodejs.org/en/download/releases
    type: string

executor:
  name: default
  tag: << parameters.version >>

steps:
  - utility/restore-repo
  - attach_workspace:
      at: .
  - run:
      name: Create SA key JSON
      command: echo $GSA_KEY > "$HOME"/gcloud_key.json
  - run:
      name: Deploy to Firebase
      command:
        GOOGLE_APPLICATION_CREDENTIALS="$HOME"/gcloud_key.json ./node_modules/.bin/firebase deploy
        <<parameters.firebase-instruction>>
  - slack/notify:
      channel: <<parameters.notify-channel-fail>>
      mentions: "@here"
      custom: |
        {
          "blocks": [
           {
        			"type": "section",
        			"text": {
        				"type": "mrkdwn",
        				"text": "ðŸ›‘ðŸ˜©ðŸ›‘ðŸ˜© *<<parameters.workflow-name>> Failed* ðŸ›‘ðŸ˜©ðŸ›‘ðŸ˜©"
        			}
        		}
          ]
        }
      event: fail
  - slack/notify:
      channel: <<parameters.notify-channel-pass>>
      custom: |
        {
          "blocks": [
           {
        			"type": "section",
        			"text": {
        				"type": "mrkdwn",
        				"text": "ðŸŽ‰ðŸŽ‰ *<<parameters.workflow-name>> Success* ðŸŽ‰ðŸŽ‰"
        			}
        		}
          ]
        }
      event: pass
